<!doctype html>
<html lang="en">
    <head>
        <script>
            if (location.hostname === 'guitar-practice-journal.com') {
                location.replace(
                    'https://www.guitar-practice-journal.com' + location.pathname + location.search + location.hash
                );
            }
        </script>

        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
        <meta name="description" content="Track your guitar practice sessions, set goals, and monitor your progress" />
        <meta name="theme-color" content="#6366f1" />
        <meta
            http-equiv="Content-Security-Policy"
            content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' blob: https://unpkg.com https://www.gstatic.com https://apis.google.com https://cdn.jsdelivr.net https://www.youtube.com https://s.ytimg.com https://www.google.com/recaptcha/ https://www.gstatic.com/recaptcha/; worker-src 'self' blob:; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: blob: https:; connect-src 'self' blob: https://*.firebaseapp.com https://*.firebaseio.com https://*.googleapis.com https://*.firebasestorage.googleapis.com https://securetoken.googleapis.com wss://*.firebaseio.com https://recaptchaenterprise.googleapis.com; frame-src 'self' https://www.youtube.com https://accounts.google.com https://*.firebaseapp.com https://www.google.com/recaptcha/ https://recaptcha.google.com/recaptcha/; media-src 'self' blob:; object-src 'none'; base-uri 'self'"
        />
        <title>Guitar Practice Journal v12.0.0</title>

        <!-- Favicon -->
        <link
            rel="icon"
            type="image/svg+xml"
            href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%236366f1;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%238b5cf6;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='32' height='32' rx='6' fill='url(%23grad)'/%3E%3Cpath d='M12 7c0-1.1.9-2 2-2h4c1.1 0 2 .9 2 2v2h-8V7zm-1 3h10v4c0 3-1 5-2.5 6.5V25c0 1.1-.9 2-2 2h-1c-1.1 0-2-.9-2-2v-4.5C12 19 11 17 11 14v-4zm3.5 4h3m-3 3h3' stroke='white' stroke-width='1.5' fill='none'/%3E%3C/svg%3E"
        />
        <link
            rel="apple-touch-icon"
            href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%236366f1;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%238b5cf6;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='32' height='32' rx='6' fill='url(%23grad)'/%3E%3Cpath d='M12 7c0-1.1.9-2 2-2h4c1.1 0 2 .9 2 2v2h-8V7zm-1 3h10v4c0 3-1 5-2.5 6.5V25c0 1.1-.9 2-2 2h-1c-1.1 0-2-.9-2-2v-4.5C12 19 11 17 11 14v-4zm3.5 4h3m-3 3h3' stroke='white' stroke-width='1.5' fill='none'/%3E%3C/svg%3E"
        />

        <!-- Global promise rejection handler - must be first -->
        <script>
            // Catch all promise rejections as early as possible
            window.addEventListener('unhandledrejection', function (event) {
                // Always prevent the default error handling for null rejections
                if (event.reason === null || event.reason === undefined || event.reason === 'null') {
                    console.warn('‚ö†Ô∏è Unhandled promise rejection: null (suppressed)');
                    event.preventDefault();
                    return;
                }

                // Suppress "cancelled" promise rejections (common during Firebase initialization)
                if (event.reason === 'cancelled' || (event.reason && event.reason.message === 'cancelled')) {
                    console.warn('‚ö†Ô∏è Unhandled promise rejection: cancelled');
                    event.preventDefault();
                    return;
                }

                console.warn('‚ö†Ô∏è Unhandled promise rejection:', event.reason);

                // Prevent for known non-critical errors
                if (
                    event.reason &&
                    event.reason.message &&
                    (event.reason.message.includes('ReCAPTCHA') ||
                        event.reason.message.includes('appCheck') ||
                        event.reason.message.includes('AudioContext') ||
                        event.reason.message.includes('cancelled'))
                ) {
                    event.preventDefault();
                    return;
                }

                // Check if it's a cancelled promise (common in Firebase operations)
                if (event.reason && event.reason.toString && event.reason.toString() === 'cancelled') {
                    event.preventDefault();
                    return;
                }

                // For other errors, let them propagate normally
            });
        </script>

        <!-- Add this before your app scripts -->
        <script>
            // Immediately redirect to login page if not logged in
            (function () {
                const currentPath = window.location.pathname;
                const isIndexPage = currentPath === '/' || currentPath === '/index.html';
                const hasUser = localStorage.getItem('currentUser');

                if (isIndexPage && !hasUser) {
                    window.location.replace('./login.html');
                }
            })();
        </script>
        <!-- Simplified base path detection -->
        <script>
            // Simple version tracking
            window.APP_VERSION = '12.0.0';
            console.log('üé∏ Loading Guitar Practice Journal version:', window.APP_VERSION);

            // Simplified base path detection
            const currentPath = window.location.pathname;
            const pathParts = currentPath.split('/').filter((p) => p.length > 0);

            // Remove filename if present
            if (pathParts.length > 0 && pathParts[pathParts.length - 1].includes('.')) {
                pathParts.pop();
            }

            // Construct base path
            let basePath = '/';
            if (pathParts.length > 0) {
                basePath = '/' + pathParts.join('/') + '/';
            }

            window.__APP_BASE_PATH__ = basePath;
            console.log('üìÅ Base path detected:', basePath);
        </script>
        <script>
            // Try to load Tone.js with fallback
            function loadToneJS() {
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/tone@14.8.49/build/Tone.js';
                script.integrity = 'sha384-c6Uo4N9c3SOEigMVzP6IshUG1wQ5uMp3xeoQFiHWAQ86joWdgyajkvopySyKy/Z6';
                script.crossOrigin = 'anonymous';
                script.onload = function () {
                    console.log('‚úÖ Tone.js loaded successfully');
                    window.TONE_LOADED = true;
                };
                script.onerror = function () {
                    console.error('Failed to load Tone.js from primary CDN, trying fallback...');
                    // Try alternative CDN
                    const fallbackScript = document.createElement('script');
                    fallbackScript.src = 'https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.js';
                    fallbackScript.integrity =
                        'sha384-c6Uo4N9c3SOEigMVzP6IshUG1wQ5uMp3xeoQFiHWAQ86joWdgyajkvopySyKy/Z6';
                    fallbackScript.crossOrigin = 'anonymous';
                    fallbackScript.onload = function () {
                        console.log('‚úÖ Tone.js loaded successfully from fallback CDN');
                        window.TONE_LOADED = true;
                    };
                    fallbackScript.onerror = function () {
                        console.error('Failed to load Tone.js from all CDNs');
                        window.TONE_LOAD_FAILED = true;
                    };
                    document.head.appendChild(fallbackScript);
                };
                document.head.appendChild(script);
            }
            loadToneJS();
        </script>
        <!-- SoundTouch for high-quality tempo/pitch adjustment -->
        <script>
            // Load SoundTouch with error handling
            (function () {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/soundtouchjs@0.1.30/dist/soundtouch.min.js';
                script.integrity = 'sha384-Uvyu44z8kqtTKP6Rm71dWcU5UCOwGbN8N6LiDYTVq0da8XnMKU99g+O3QBXc7Ftl';
                script.crossOrigin = 'anonymous';
                script.onerror = function () {
                    console.warn('‚ö†Ô∏è SoundTouch library failed to load. Pitch shifting will be unavailable.');
                    window.SoundTouch = null; // Set to null so the app knows it's not available
                };
                document.head.appendChild(script);
            })();
        </script>
        <!-- YouTube iframe API (Note: YouTube API doesn't support SRI) -->
        <script src="https://www.youtube.com/iframe_api"></script>

        <!-- Load CSS -->
        <link rel="stylesheet" href="styles/bundle.min.css" />

        <!-- Favicon -->

        <!-- PWA Manifest -->
        <link rel="manifest" href="./manifest.json" />
    </head>
    <body>
        <div id="app">
            <!-- Loading state -->
            <div
                class="app-loading"
                style="
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    min-height: 100vh;
                    background: #0a0a0a;
                "
            >
                <div
                    class="loading-spinner"
                    style="
                        width: 50px;
                        height: 50px;
                        border: 3px solid #374151;
                        border-top-color: #6366f1;
                        border-radius: 50%;
                        animation: spin 1s linear infinite;
                    "
                ></div>
                <p style="color: #e0e0e0; margin-top: 20px" id="loadingVersionText">
                    Loading Guitar Practice Journal...
                </p>
                <div
                    id="error-message"
                    style="color: #ef4444; margin-top: 20px; text-align: center; max-width: 600px; display: none"
                ></div>
                <div
                    id="debug-info"
                    style="color: #9ca3af; margin-top: 10px; font-size: 12px; font-family: monospace; display: none"
                ></div>
            </div>
        </div>

        <style>
            /* Critical CSS for loading state */
            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }
                100% {
                    transform: rotate(360deg);
                }
            }

            body {
                margin: 0;
                padding: 0;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                background: #0a0a0a;
                color: #f9fafb;
            }

            .app-loading {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                z-index: 9999;
            }

            #error-message {
                max-width: 90%;
                margin: 0 auto;
                padding: 1rem;
                background: rgba(239, 68, 68, 0.1);
                border: 1px solid #ef4444;
                border-radius: 8px;
                line-height: 1.5;
            }

            #error-message button {
                margin: 0.5rem;
                padding: 0.5rem 1rem;
                background: #6366f1;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }

            #error-message button:hover {
                background: #5856eb;
            }
        </style>

        <!-- Simplified App Loading Script -->
        <script type="module">
            console.log('üöÄ Starting app initialization...');

            const debugInfo = document.getElementById('debug-info');
            const errorDiv = document.getElementById('error-message');

            function showDebugInfo(message) {
                // console.log('üîß Debug:', message);
                if (debugInfo) {
                    debugInfo.style.display = 'block';
                    debugInfo.textContent = `Debug: ${message}`;
                }
            }

            function showError(message, error = null) {
                // console.error('‚ùå Error:', message, error);
                if (errorDiv) {
                    errorDiv.style.display = 'block';
                    // Clear existing content
                    errorDiv.innerHTML = '';

                    // Create error content safely
                    const strongEl = document.createElement('strong');
                    strongEl.textContent = 'Application Error';
                    errorDiv.appendChild(strongEl);
                    errorDiv.appendChild(document.createElement('br'));

                    const messageEl = document.createElement('span');
                    messageEl.textContent = message;
                    errorDiv.appendChild(messageEl);
                    errorDiv.appendChild(document.createElement('br'));
                    errorDiv.appendChild(document.createElement('br'));

                    const reloadBtn = document.createElement('button');
                    reloadBtn.textContent = 'Reload Page';
                    reloadBtn.onclick = () => location.reload();
                    errorDiv.appendChild(reloadBtn);

                    const clearCacheBtn = document.createElement('button');
                    clearCacheBtn.textContent = 'Clear Cache & Reload';
                    clearCacheBtn.onclick = clearCacheAndReload;
                    errorDiv.appendChild(clearCacheBtn);
                }
            }

            // Cache clearing function
            window.clearCacheAndReload = async function () {
                try {
                    if ('caches' in window) {
                        const cacheNames = await caches.keys();
                        await Promise.all(cacheNames.map((name) => caches.delete(name)));
                    }
                    localStorage.clear();
                    sessionStorage.clear();
                    if ('serviceWorker' in navigator) {
                        const registrations = await navigator.serviceWorker.getRegistrations();
                        for (let registration of registrations) {
                            await registration.unregister();
                        }
                    }
                    location.reload(true);
                } catch (error) {
                    console.error('Cache clear error:', error);
                    location.reload(true);
                }
            };

            // Global error handler
            window.addEventListener('error', (e) => {
                showError(`Script error: ${e.message}`, e);
            });

            window.addEventListener('unhandledrejection', (e) => {
                // Ignore null rejections
                if (e.reason === null || e.reason === undefined || e.reason === 'null') {
                    e.preventDefault();
                    return;
                }

                // Ignore "cancelled" promise rejections - common during Firebase init
                if (e.reason === 'cancelled' || (e.reason && e.reason.message === 'cancelled')) {
                    console.warn('‚ö†Ô∏è Ignoring cancelled promise rejection');
                    e.preventDefault();
                    return;
                }

                // Ignore App Check ReCAPTCHA errors - they're non-critical
                if (
                    e.reason &&
                    ((e.reason.message && e.reason.message.includes('ReCAPTCHA')) ||
                        (e.reason.toString && e.reason.toString().includes('ReCAPTCHA')) ||
                        (e.reason.code && e.reason.code === 'appCheck/recaptcha-error'))
                ) {
                    console.warn('‚ö†Ô∏è Ignoring non-critical App Check error:', e.reason);
                    e.preventDefault(); // Prevent the error from showing
                    return;
                }
                showError(`Promise rejection: ${e.reason}`, e);
            });

            // Set version in loading text
            (async function setLoadingVersion() {
                try {
                    const versionModule = await import('./src/config/version.js');
                    const loadingText = document.getElementById('loadingVersionText');
                    if (loadingText) {
                        loadingText.textContent = `Loading Guitar Practice Journal v${versionModule.APP_VERSION}...`;
                    }
                } catch (error) {
                    console.warn('Could not load version for loading screen:', error);
                    // Fallback to default text if version loading fails
                    const loadingText = document.getElementById('loadingVersionText');
                    if (loadingText) {
                        loadingText.textContent = 'Loading Guitar Practice Journal v12.0.0...';
                    }
                }
            })();

            // Initialize app
            async function initializeApp() {
                try {
                    showDebugInfo('Loading configuration...');

                    // Import config with timeout
                    const configPromise = import('./src/config.js');
                    const configTimeout = new Promise((_, reject) =>
                        setTimeout(() => reject(new Error('Config loading timeout')), 10000)
                    );

                    const configModule = await Promise.race([configPromise, configTimeout]);
                    const appConfig = configModule.default;

                    showDebugInfo('Configuration loaded successfully');
                    console.log('üìã Config loaded:', appConfig.basePath);

                    showDebugInfo('Loading main application...');

                    // Import app with timeout
                    const appPromise = import('./src/app.js');
                    const appTimeout = new Promise((_, reject) =>
                        setTimeout(() => reject(new Error('App loading timeout')), 10000)
                    );

                    const appModule = await Promise.race([appPromise, appTimeout]);
                    const { App } = appModule;

                    showDebugInfo('Application module loaded, initializing...');
                    console.log('üé∏ App class loaded, creating instance...');

                    // Create and initialize app
                    window.app = new App();

                    showDebugInfo('Calling app.init()...');
                    try {
                        await window.app.init();
                        console.log('‚úÖ App initialized successfully!');
                    } catch (initError) {
                        console.error('App init error:', initError);
                        // Continue app loading even if some services fail
                        console.log('‚ö†Ô∏è App initialized with warnings');
                    }

                    // Hide loading screen
                    const loader = document.querySelector('.app-loading');
                    if (loader) {
                        loader.style.display = 'none';
                    }
                } catch (error) {
                    console.error('‚ùå App initialization failed:', error);

                    if (error.message.includes('timeout')) {
                        showError('App loading timed out. This might be a network issue or missing files.');
                    } else if (error.message.includes('Failed to resolve module specifier')) {
                        showError(
                            `Module not found: ${error.message}. Check that all files exist in the src/ directory.`
                        );
                    } else if (error.message.includes('Failed to fetch')) {
                        showError('Failed to load required files. Check your internet connection and file structure.');
                    } else {
                        showError(`Initialization failed: ${error.message}`);
                    }
                }
            }

            // Start initialization when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializeApp);
            } else {
                initializeApp();
            }

            // Fallback timeout - if app doesn't load in 30 seconds, show error
            setTimeout(() => {
                const loader = document.querySelector('.app-loading');
                if (loader && loader.style.display !== 'none') {
                    showError(
                        'App failed to load within 30 seconds. There may be a problem with the application files.'
                    );
                }
            }, 30000);
        </script>

        <!-- Firebase SDKs with SRI -->
        <script
            src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"
            integrity="sha384-ViccRjS0k/lvYsrtaKXk+ES61/4PAZlFI/mPHmLC1YWzK0AIbXbI5ZXDzcm3F8gH"
            crossorigin="anonymous"
        ></script>
        <script
            src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"
            integrity="sha384-+/4lqMnmLqwbdHXshvGDmBTeWlNoPRdjXi4ZsiBj10EhQXaTBe3RF5JZktdSjug6"
            crossorigin="anonymous"
        ></script>
        <script
            src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"
            integrity="sha384-7TetnPNdXXu6qURzIEXWCwpXedGGBJSXIR5Cv0gOWTB34UD5TxPHx33PhjA6wFQ3"
            crossorigin="anonymous"
        ></script>
        <script
            src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-check-compat.js"
            integrity="sha384-iF93NE9DFYjJ/GJcb4h18LKfvMn3Ppl4GSSFZ8RFvwc7OtGGQSHQXbHEdO8Rknhj"
            crossorigin="anonymous"
        ></script>

        <!-- Service Worker Registration -->
        <script>
            if ('serviceWorker' in navigator && window.location.protocol !== 'file:') {
                window.addEventListener('load', async () => {
                    try {
                        const registration = await navigator.serviceWorker.register('service-worker.js');
                        console.log('‚úÖ Service Worker registered successfully');
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Service Worker registration failed:', error);
                        // Don't block app loading if SW fails
                    }
                });
            }
        </script>
    </body>
</html>
