<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Database Test</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #45a049;
        }
        .error {
            color: red;
            padding: 10px;
            background: #ffebee;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            color: green;
            padding: 10px;
            background: #e8f5e9;
            border-radius: 4px;
            margin: 10px 0;
        }
        .info {
            color: #1976d2;
            padding: 10px;
            background: #e3f2fd;
            border-radius: 4px;
            margin: 10px 0;
        }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-connected { background: #4CAF50; }
        .status-disconnected { background: #f44336; }
    </style>
</head>
<body>
    <h1>üî• Firebase Database Test</h1>
    
    <div class="test-section">
        <h2>1. Authentication Status</h2>
        <div id="authStatus">Checking...</div>
        <button onclick="checkAuth()">Check Auth Status</button>
        <button onclick="getCurrentUser()">Get Current User</button>
    </div>

    <div class="test-section">
        <h2>2. Firebase Connection</h2>
        <div id="connectionStatus">Checking...</div>
        <button onclick="testConnection()">Test Connection</button>
    </div>

    <div class="test-section">
        <h2>3. Database Write Test</h2>
        <button onclick="writeTestData()">Write Test Data</button>
        <button onclick="writeComplexData()">Write Complex Practice Data</button>
        <div id="writeResult"></div>
    </div>

    <div class="test-section">
        <h2>4. Database Read Test</h2>
        <button onclick="readTestData()">Read Test Data</button>
        <button onclick="readAllUserData()">Read All User Data</button>
        <div id="readResult"></div>
    </div>

    <div class="test-section">
        <h2>5. Storage Service Test</h2>
        <button onclick="testStorageService()">Test Storage Service Write</button>
        <button onclick="checkSyncStatus()">Check Sync Status</button>
        <div id="storageResult"></div>
    </div>

    <div class="test-section">
        <h2>6. Console Logs</h2>
        <button onclick="clearLogs()">Clear Logs</button>
        <pre id="logs"></pre>
    </div>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDlHH4pCbdUaNrWx3iK_YqyqPvKNeVJSLQ",
            authDomain: "guitar-practice-journal-9f064.firebaseapp.com",
            projectId: "guitar-practice-journal-9f064",
            storageBucket: "guitar-practice-journal-9f064.appspot.com",
            messagingSenderId: "951369871259",
            appId: "1:951369871259:web:d57d4f39bb3a6033947b72"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Log helper
        function log(message, type = 'info') {
            const logsEl = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'blue';
            logsEl.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span>\n`;
            console.log(`[${type}] ${message}`);
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        // Check authentication
        async function checkAuth() {
            try {
                const user = auth.currentUser;
                const statusEl = document.getElementById('authStatus');
                
                if (user) {
                    statusEl.innerHTML = `<div class="success">
                        <span class="status-indicator status-connected"></span>
                        Authenticated as: ${user.email} (${user.uid})
                    </div>`;
                    log(`Authenticated: ${user.email}`, 'success');
                } else {
                    statusEl.innerHTML = `<div class="error">
                        <span class="status-indicator status-disconnected"></span>
                        Not authenticated
                    </div>`;
                    log('Not authenticated', 'error');
                }
            } catch (error) {
                log(`Auth check error: ${error.message}`, 'error');
            }
        }

        // Get current user details
        async function getCurrentUser() {
            const user = auth.currentUser;
            if (user) {
                log(`User details: ${JSON.stringify({
                    uid: user.uid,
                    email: user.email,
                    emailVerified: user.emailVerified,
                    createdAt: user.metadata.creationTime
                }, null, 2)}`, 'info');
            } else {
                log('No user logged in', 'error');
            }
        }

        // Test connection
        async function testConnection() {
            const statusEl = document.getElementById('connectionStatus');
            try {
                // Try to read a simple document
                const testDoc = await db.collection('_test').doc('connection').get();
                statusEl.innerHTML = '<div class="success">‚úÖ Connected to Firestore</div>';
                log('Firestore connection successful', 'success');
            } catch (error) {
                statusEl.innerHTML = `<div class="error">‚ùå Connection failed: ${error.message}</div>`;
                log(`Connection error: ${error.message}`, 'error');
            }
        }

        // Write test data
        async function writeTestData() {
            const resultEl = document.getElementById('writeResult');
            const user = auth.currentUser;
            
            if (!user) {
                resultEl.innerHTML = '<div class="error">Please log in first</div>';
                return;
            }

            try {
                const testData = {
                    message: 'Test write from Firebase test page',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    userId: user.uid,
                    email: user.email,
                    testId: Date.now()
                };

                await db.collection('users').doc(user.uid).collection('test').add(testData);
                resultEl.innerHTML = '<div class="success">‚úÖ Test data written successfully</div>';
                log(`Test data written: ${JSON.stringify(testData)}`, 'success');
            } catch (error) {
                resultEl.innerHTML = `<div class="error">‚ùå Write failed: ${error.message}</div>`;
                log(`Write error: ${error.message}`, 'error');
            }
        }

        // Write complex practice data
        async function writeComplexData() {
            const resultEl = document.getElementById('writeResult');
            const user = auth.currentUser;
            
            if (!user) {
                resultEl.innerHTML = '<div class="error">Please log in first</div>';
                return;
            }

            try {
                const practiceData = {
                    date: new Date().toISOString(),
                    duration: 1800,
                    practiceArea: 'Scales',
                    tempo: 120,
                    notes: 'Test practice session',
                    goals: ['Improve speed', 'Clean playing'],
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };

                const docRef = await db.collection('users').doc(user.uid)
                    .collection('practiceEntries').add(practiceData);
                
                resultEl.innerHTML = `<div class="success">‚úÖ Practice data written with ID: ${docRef.id}</div>`;
                log(`Practice data written: ${JSON.stringify(practiceData)}`, 'success');
            } catch (error) {
                resultEl.innerHTML = `<div class="error">‚ùå Write failed: ${error.message}</div>`;
                log(`Write error: ${error.message}`, 'error');
            }
        }

        // Read test data
        async function readTestData() {
            const resultEl = document.getElementById('readResult');
            const user = auth.currentUser;
            
            if (!user) {
                resultEl.innerHTML = '<div class="error">Please log in first</div>';
                return;
            }

            try {
                const snapshot = await db.collection('users').doc(user.uid)
                    .collection('test').orderBy('timestamp', 'desc').limit(5).get();
                
                if (snapshot.empty) {
                    resultEl.innerHTML = '<div class="info">No test data found</div>';
                    log('No test data found', 'info');
                } else {
                    const data = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                    resultEl.innerHTML = `<div class="success">Found ${data.length} test documents</div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>`;
                    log(`Read ${data.length} test documents`, 'success');
                }
            } catch (error) {
                resultEl.innerHTML = `<div class="error">‚ùå Read failed: ${error.message}</div>`;
                log(`Read error: ${error.message}`, 'error');
            }
        }

        // Read all user data
        async function readAllUserData() {
            const resultEl = document.getElementById('readResult');
            const user = auth.currentUser;
            
            if (!user) {
                resultEl.innerHTML = '<div class="error">Please log in first</div>';
                return;
            }

            try {
                const collections = ['practiceEntries', 'goals', 'repertoire', 'settings'];
                const results = {};

                for (const collection of collections) {
                    const snapshot = await db.collection('users').doc(user.uid)
                        .collection(collection).limit(5).get();
                    results[collection] = {
                        count: snapshot.size,
                        data: snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}))
                    };
                }

                resultEl.innerHTML = `<div class="success">User data summary:</div>
                    <pre>${JSON.stringify(results, null, 2)}</pre>`;
                log('User data read successfully', 'success');
            } catch (error) {
                resultEl.innerHTML = `<div class="error">‚ùå Read failed: ${error.message}</div>`;
                log(`Read error: ${error.message}`, 'error');
            }
        }

        // Test storage service
        async function testStorageService() {
            const resultEl = document.getElementById('storageResult');
            
            try {
                // Import and test the actual storage service
                const module = await import('./src/services/storageService.js');
                const StorageService = module.StorageService;
                const storage = new StorageService();
                
                // Try to save a test entry
                const testEntry = {
                    date: new Date().toISOString(),
                    duration: 600,
                    practiceArea: 'Test from Firebase Test Page',
                    tempo: 100,
                    notes: 'Testing storage service'
                };
                
                await storage.savePracticeEntry(testEntry);
                resultEl.innerHTML = '<div class="success">‚úÖ Storage service write successful</div>';
                log('Storage service test successful', 'success');
            } catch (error) {
                resultEl.innerHTML = `<div class="error">‚ùå Storage service error: ${error.message}</div>`;
                log(`Storage service error: ${error.message}`, 'error');
            }
        }

        // Check sync status
        async function checkSyncStatus() {
            const resultEl = document.getElementById('storageResult');
            
            try {
                const module = await import('./src/services/firebaseSyncService.js');
                const syncService = module.default;
                
                const isEnabled = await syncService.isEnabled();
                const user = await syncService.getCurrentUser();
                
                resultEl.innerHTML = `<div class="info">
                    Sync Enabled: ${isEnabled}<br>
                    User: ${user ? user.email : 'Not logged in'}<br>
                    Firebase Initialized: ${syncService.initialized}
                </div>`;
                
                log(`Sync status - Enabled: ${isEnabled}, User: ${user?.email}`, 'info');
            } catch (error) {
                resultEl.innerHTML = `<div class="error">‚ùå Sync check error: ${error.message}</div>`;
                log(`Sync check error: ${error.message}`, 'error');
            }
        }

        // Auto-check on load
        auth.onAuthStateChanged((user) => {
            if (user) {
                log(`Auth state changed: ${user.email} logged in`, 'success');
                checkAuth();
            } else {
                log('Auth state changed: No user', 'info');
                checkAuth();
            }
        });

        // Initial checks
        setTimeout(() => {
            checkAuth();
            testConnection();
        }, 1000);
    </script>
</body>
</html>