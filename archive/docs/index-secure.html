<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="description" content="Track your guitar practice sessions, set goals, and monitor your progress">
    <meta name="theme-color" content="#6366f1">
    <!-- Strict Content Security Policy -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://www.gstatic.com/firebasejs/9.22.0/ https://unpkg.com/tone@14.8.49/ https://cdn.jsdelivr.net/npm/soundtouchjs@0.1.30/ https://www.youtube.com/iframe_api https://s.ytimg.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: blob: https:; connect-src 'self' blob: https://*.firebaseapp.com https://*.firebaseio.com https://*.googleapis.com https://*.firebasestorage.googleapis.com https://securetoken.googleapis.com wss://*.firebaseio.com https://recaptchaenterprise.googleapis.com; frame-src 'self' https://www.youtube.com https://accounts.google.com https://*.firebaseapp.com; frame-ancestors 'self'; object-src 'none'; worker-src 'self' blob:; media-src 'self' blob:; base-uri 'self'; form-action 'self'; upgrade-insecure-requests;">
    
    <title>Guitar Practice Journal v10.98</title>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%236366f1;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%238b5cf6;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='32' height='32' rx='6' fill='url(%23grad)'/%3E%3Cpath d='M12 7c0-1.1.9-2 2-2h4c1.1 0 2 .9 2 2v2h-8V7zm-1 3h10v4c0 3-1 5-2.5 6.5V25c0 1.1-.9 2-2 2h-1c-1.1 0-2-.9-2-2v-4.5C12 19 11 17 11 14v-4zm3.5 4h3m-3 3h3' stroke='white' stroke-width='1.5' fill='none'/%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%236366f1;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%238b5cf6;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='32' height='32' rx='6' fill='url(%23grad)'/%3E%3Cpath d='M12 7c0-1.1.9-2 2-2h4c1.1 0 2 .9 2 2v2h-8V7zm-1 3h10v4c0 3-1 5-2.5 6.5V25c0 1.1-.9 2-2 2h-1c-1.1 0-2-.9-2-2v-4.5C12 19 11 17 11 14v-4zm3.5 4h3m-3 3h3' stroke='white' stroke-width='1.5' fill='none'/%3E%3C/svg%3E">

    <!-- Critical initialization scripts (external files) -->
    <script src="./src/init/domainRedirect.js"></script>
    <script src="./src/init/errorHandler.js"></script>
    <script src="./src/init/authCheck.js"></script>
    <script src="./src/init/appConfig.js"></script>
    
    <!-- Third-party libraries with SRI -->
    <!-- Tone.js for audio processing -->
    <script src="https://unpkg.com/tone@14.8.49/build/Tone.js" 
            integrity="sha384-c6Uo4N9c3SOEigMVzP6IshUG1wQ5uMp3xeoQFiHWAQ86joWdgyajkvopySyKy/Z6" 
            crossorigin="anonymous"
            onerror="window.TONE_LOAD_FAILED = true; console.error('Failed to load Tone.js');">
    </script>
    
    <!-- SoundTouch for pitch shifting -->
    <script src="https://cdn.jsdelivr.net/npm/soundtouchjs@0.1.30/dist/soundtouch.min.js"
            integrity="sha384-Uvyu44z8kqtTKP6Rm71dWcU5UCOwGbN8N6LiDYTVq0da8XnMKU99g+O3QBXc7Ftl"
            crossorigin="anonymous"
            onerror="window.SoundTouch = null; console.warn('SoundTouch failed to load');">
    </script>
    
    <!-- YouTube iframe API -->
    <script src="https://www.youtube.com/iframe_api"></script>

    <!-- Load CSS -->
    <link rel="stylesheet" href="styles/main.css">

    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json">
</head>
<body>
<div id="app">
    <!-- Loading state -->
    <div class="app-loading"
         style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; background: #0a0a0a;">
        <div class="loading-spinner"
             style="width: 50px; height: 50px; border: 3px solid #374151; border-top-color: #6366f1; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <p style="color: #e0e0e0; margin-top: 20px;" id="loadingVersionText">Loading Guitar Practice Journal...</p>
        <div id="error-message"
             style="color: #ef4444; margin-top: 20px; text-align: center; max-width: 600px; display: none;"></div>
        <div id="debug-info"
             style="color: #9ca3af; margin-top: 10px; font-size: 12px; font-family: monospace; display: none;"></div>
    </div>
</div>

<style>
    /* Critical CSS for loading state */
    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }

    body {
        margin: 0;
        padding: 0;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: #0a0a0a;
        color: #f9fafb;
    }

    .app-loading {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 9999;
    }

    #error-message {
        max-width: 90%;
        margin: 0 auto;
        padding: 1rem;
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid #ef4444;
        border-radius: 8px;
        line-height: 1.5;
    }

    #error-message button {
        margin: 0.5rem;
        padding: 0.5rem 1rem;
        background: #6366f1;
        border: none;
        color: white;
        border-radius: 4px;
        cursor: pointer;
    }

    #error-message button:hover {
        background: #4f46e5;
    }
</style>

<!-- Simplified App Loading Script -->
<script type="module">
    console.log('üöÄ Starting app initialization...');
    const debugInfo = document.getElementById('debug-info');
    const errorDiv = document.getElementById('error-message');
    
    // Update loading text with version
    const loadingText = document.getElementById('loadingVersionText');
    if (loadingText && window.APP_VERSION) {
        loadingText.textContent = `Loading Guitar Practice Journal v${window.APP_VERSION}...`;
    }

    try {
        // Check for module support
        if (!window.customElements) {
            throw new Error('Your browser does not support modern JavaScript features required by this app.');
        }

        // Load and start the app
        const { App } = await import('./src/app.js');
        const app = new App();
        await app.init();
        console.log('‚úÖ App initialized successfully');

    } catch (error) {
        console.error('‚ùå App initialization failed:', error);
        
        // Enhanced error display
        let errorMessage = 'Failed to load the application. ';
        
        if (error.message.includes('module')) {
            errorMessage += 'Your browser may not support modern JavaScript modules.';
        } else if (error.message.includes('network')) {
            errorMessage += 'Please check your internet connection.';
        } else {
            errorMessage += error.message || 'Please try refreshing the page.';
        }
        
        errorDiv.innerHTML = `
            <h3>‚ö†Ô∏è Loading Error</h3>
            <p>${errorMessage}</p>
            <div style="margin-top: 1rem;">
                <button onclick="location.reload()">üîÑ Reload Page</button>
                <button onclick="localStorage.clear(); location.reload()">üßπ Clear Cache & Reload</button>
            </div>
            <details style="margin-top: 1rem; text-align: left;">
                <summary style="cursor: pointer;">Technical Details</summary>
                <pre style="margin-top: 0.5rem; padding: 0.5rem; background: rgba(0,0,0,0.5); border-radius: 4px; overflow-x: auto; font-size: 11px;">${error.stack || error.toString()}</pre>
            </details>
        `;
        errorDiv.style.display = 'block';
        
        // Show debug info
        if (debugInfo) {
            debugInfo.innerHTML = `
                <div>Browser: ${navigator.userAgent}</div>
                <div>App Version: ${window.APP_VERSION || 'Unknown'}</div>
                <div>Base Path: ${window.BASE_PATH || 'Not detected'}</div>
            `;
            debugInfo.style.display = 'block';
        }
    }
</script>

<!-- Firebase SDKs with SRI -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"
        integrity="sha384-ViccRjS0k/lvYsrtaKXk+ES61/4PAZlFI/mPHmLC1YWzK0AIbXbI5ZXDzcm3F8gH"
        crossorigin="anonymous"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"
        integrity="sha384-+/4lqMnmLqwbdHXshvGDmBTeWlNoPRdjXi4ZsiBj10EhQXaTBe3RF5JZktdSjug6"
        crossorigin="anonymous"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"
        integrity="sha384-7TetnPNdXXu6qURzIEXWCwpXedGGBJSXIR5Cv0gOWTB34UD5TxPHx33PhjA6wFQ3"
        crossorigin="anonymous"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-check-compat.js"
        integrity="sha384-iF93NE9DFYjJ/GJcb4h18LKfvMn3Ppl4GSSFZ8RFvwc7OtGGQSHQXbHEdO8Rknhj"
        crossorigin="anonymous"></script>

<!-- Service Worker Registration -->
<script src="./src/init/serviceWorkerRegistration.js" type="module"></script>

</body>
</html>